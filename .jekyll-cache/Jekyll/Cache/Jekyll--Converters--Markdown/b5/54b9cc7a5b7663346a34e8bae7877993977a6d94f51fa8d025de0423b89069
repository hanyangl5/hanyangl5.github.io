I"ş<h3 id="z_bufferä¸ºä»€ä¹ˆæ˜¯éçº¿æ€§çš„">z_bufferä¸ºä»€ä¹ˆæ˜¯éçº¿æ€§çš„</h3>
<p>å¼•ç”¨<a href="http://www.humus.name/index.php?page=News&amp;ID=255">humus:A couple of notes about Z</a>çš„ä¸€å¥è¯</p>

<p>While W is linear in view space itâ€™s not linear in screen space. Z, which is non-linear in view space, is on the other hand linear in screen space</p>

<h3 id="z_bufferç²¾åº¦é—®é¢˜">z_bufferç²¾åº¦é—®é¢˜</h3>

<p>åœ¨æŠ•å½±é˜¶æ®µï¼Œæˆ‘ä»¬å°†view spaceä¸­çš„zå€¼æ˜ å°„æˆäº†å…³äº1/zçš„å‡½æ•°
å¾—åˆ°ä¸€ä¸ªå¦‚ä¸‹å½¢å¼çš„å‡½æ•°å›¾åƒ
<img src="https://pic.downk.cc/item/5f3a690214195aa594a499b7.png" alt="" /></p>

<p>åœ¨è¿‘å¹³é¢æ—¶ï¼Œzâ€™â€˜çš„ç²¾åº¦è¾ƒé«˜ï¼Œæ·±åº¦ç¼“å†²æœ‰è¾ƒå¥½çš„è¡¨ç°ï¼Œæˆ‘ä»¬åœ¨æ·±åº¦ç¼“å†²æ—¶å¯ä»¥å¾ˆå®¹æ˜“åˆ¤æ–­å‡ºç‰©ä½“çš„å‰å</p>

<p>åœ¨è¿œå¹³é¢é™„è¿‘ï¼ŒåŒæ ·zå€¼ç›¸å·®ä¸º1ï¼Œzâ€™â€˜çš„å€¼ç›¸å·®å¾ˆå°ï¼Œç”šè‡³ä¼šè®¡ç®—å‡ºç›¸åŒçš„æ·±åº¦å€¼ï¼Œè¿™æ—¶å°±æ— æ³•åˆ†è¾¨å“ªä¸ªç‰©ä½“åœ¨å‰ï¼Œå“ªä¸ªç‰©ä½“åœ¨åï¼Œè¿™å°±æ˜¯depth precision error(z fighting)</p>

<p><img src="https://pic.downk.cc/item/5f3a690214195aa594a499b4.png" alt="" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">z fighting</center>

<p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p>

<ul>
  <li>
    <p>å°†znearè®¾ç½®çš„å°½å¯èƒ½å°å¯ä»¥æ”¹å–„zâ€™â€˜çš„åˆ†å¸ƒï¼Œå°†æ›´å¤šçš„å˜åŒ–ç©ºé—´ç•™ç»™è¿œå¹³é¢</p>
  </li>
  <li>
    <p>ä½¿ç”¨æ— é™è¿œå¹³é¢</p>
  </li>
  <li>
    <p>ç”¨ç²¾åº¦æ›´é«˜çš„æ•°æ®ç±»å‹å­˜å‚¨</p>
  </li>
  <li>
    <p>ä½¿æŠ•å½±çŸ©é˜µä¸å…¶ä»–çŸ©é˜µåˆ†å¼€ï¼Œå¹¶å°†å…¶åº”ç”¨äºé¡¶ç‚¹ç€è‰²å™¨ä¸­çš„å•ç‹¬æ“ä½œä¸­ï¼Œè€Œä¸æ˜¯å°†å…¶ç»„åˆåˆ°è§†å›¾çŸ©é˜µä¸­-</p>
  </li>
</ul>

<p>P.S.</p>
<blockquote>
  <p>Differentiating depth between close objects is more important than differentiating depth between far objects</p>
</blockquote>

<!-- 
# integer depth buffer

å‡è®¾æˆ‘ä»¬ç”¨integerç±»å‹å­˜å‚¨zå€¼ï¼Œé‚£ä¹ˆzç²¾ç¡®åº¦æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼Œå®šä¹‰æ˜ å°„å‡½æ•°$f(x)$

æˆ‘ä»¬è®¾depthbufferç²¾ç¡®åº¦ä¸ºsï¼ˆdepthbufferä¸­ä¸¤ä¸ªç‚¹zå€¼å·®çš„æœ€å°å€¼ï¼Œintç±»å‹å¯è®¾ä¸º1ï¼‰ï¼Œview spaceç²¾ç¡®åº¦$c$

å¾—åˆ°$f(z) - f(z+C)=s$
$f(x) = he^{x}$ -->

<h3 id="reverse-z">reverse-z</h3>

<p>åœ¨ä¸Šé¢çš„æè¿°ä¸­ï¼Œzbufferçš„å€¼åº”è¯¥æ˜¯è¿‘å¹³é¢è¶‹è¿‘0ï¼Œè¿œå¹³é¢è¶‹è¿‘1ï¼ˆDirectXï¼‰ï¼Œæ¸²æŸ“å‡ºæ¥çš„æ•ˆæœæ˜¯è¿‘å¹³é¢é¢œè‰²æ·±ï¼Œè¿œå¹³é¢é¢œè‰²æµ…ï¼Œæœ€è¿‘çœ‹åˆ°ä¸€ç¯‡åšå®¢åœ¨åˆ†æGTA5æ¸²æŸ“æ—¶ï¼Œzbufferçš„å€¼æ­£å¥½ç›¸åï¼Œæ˜¯ç”¨äº†reverse-zçš„æŠ€æœ¯</p>

<p><img src="https://images2015.cnblogs.com/blog/503123/201601/503123-20160112092820882-537489601.jpg" alt="" /></p>

<p>(Nvidiaå®˜æ–¹çš„æ¡ˆä¾‹æ˜¯DirectXä¸ºä¾‹çš„)</p>

<p>DirectXä¸­zçš„æŠ•å½±å˜æ¢ï¼ˆz&gt;0ï¼Œzæ˜ å°„åˆ°[0,1]ï¼‰
$zâ€™â€™=\frac{z_{far}}{z_{far}-z_{near}}-\frac{z_{far}\ z_{near}}{z_{far}-z_{near}}\frac{1}{zp}$</p>

<p>æ ‡å‡†çš„zbufferç²¾åº¦æ›²çº¿</p>

<p><img src="https://developer.nvidia.com/sites/default/files/akamai/gameworks/blog/Depthprecision/graph4.jpg" alt="" /></p>
<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">DirectX</center>

<p>reverse-zçš„åšæ³•æ˜¯ï¼Œå°†è¿‘å¹³é¢æ˜ å°„åˆ°z=1ï¼Œå°†è¿œå¹³é¢æ˜ å°„åˆ°z=0ï¼Œä½¿å¾—æµ®ç‚¹çš„å‡†å¯¹æ•°åˆ†å¸ƒåœ¨æŸç§ç¨‹åº¦ä¸Šå–æ¶ˆäº†1/zéçº¿æ€§ï¼Œä½¿æˆ‘ä»¬åœ¨è¿‘å¹³é¢ä¸Šçš„ç²¾åº¦ä¸æ•´æ•°æ·±åº¦ç¼“å†²åŒºç›¸ä¼¼ï¼Œå¹¶ä¸”æå¤§åœ°æé«˜äº†å…¶ä»–åœ°æ–¹çš„ç²¾åº¦</p>

<p>$zâ€™â€™=\frac{z_{near}}{z_{near}-z_{far}}-\frac{z_{near}\ z_{far}}{z_{near}-z_{far}}\frac{1}{zp}$</p>

<p><img src="https://developer.nvidia.com/sites/default/files/akamai/gameworks/blog/Depthprecision/graph5.jpg" alt="" /></p>

<p>ä½†åœ¨OpenGLä¸­ï¼Œç”±äºzå€¼æ˜ å°„åˆ°[-1,1]ï¼Œè¿œå¹³é¢éƒ¨åˆ†çš„æ•°æ®ç²¾åº¦è¢«ç ´åï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨è¿™ç§æ–¹æ³•</p>

<p><img src="https://developer.nvidia.com/sites/default/files/akamai/gameworks/blog/Depthprecision/graph6.jpg" alt="" /></p>
<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">OpenGL</center>

<h3 id="multiple-frusta">multiple frusta</h3>

<p>rtr4ä¸­å¦ä¸€ç§å‡å°‘z fightingçš„åšæ³•ï¼Œæ¸²æŸ“å¤šä¸ªfrustum</p>

<p>Cozzi proposes to use multiple frusta, which can improve accuracy to effectively any desired rate. The view frustum is divided in the depth direction into
several non-overlapping smaller sub-frusta whose union is exactly the frustum. The
sub-frusta are rendered to in back-to-front order. First, both the color and depth
buffers are cleared, and all objects to be rendered are sorted into each sub-frusta that
they overlap. For each sub-frusta, its projection matrix is set up, the depth buffer is
cleared, and then the objects that overlap the sub-frusta are rendered.</p>

<h3 id="early-z">early-z</h3>

<p>åœ¨late depth testä¸­ï¼Œæ˜¯åœ¨fragmentshaderåè®¡ç®—zå€¼ï¼Œåšæ·±åº¦æµ‹è¯•ï¼Œearly-zæ˜¯åœ¨fragmentshaderä¹‹å‰è®¡ç®—zå€¼ï¼Œå¹¶æ ¹æ®å¯è§†æ€§discardæ‰å¤šä½™çš„åƒç´ ï¼Œè¿™ä¸€åŠŸèƒ½å·²ç»é›†æˆåœ¨å›¾å½¢apiä¸­</p>

<p><strong>reference:</strong></p>

<p>https://developer.nvidia.com/content/depth-precision-visualized
http://www.adriancourreges.com/blog/2015/11/02/gta-v-graphics-study/
https://www.khronos.org/opengl/wiki/Depth_Buffer_Precision
https://www.gamedev.net/forums/topic.asp?topic_id=539378
http://www.humus.name/index.php?page=News&amp;ID=255</p>
:ET